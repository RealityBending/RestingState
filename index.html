<!-- Load jsPsych-->
<!DOCTYPE html>
<html>

<head>
    <!--create title shown in tab; not the same as header on webpage-->
    <title>RestingState</title>

    <script src="https://unpkg.com/jspsych@7.2.3"></script>

    <!--Load all necessary plugins using cdn hosted library-->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
    <script src="utils/multiple-slider.js"></script>
    <script src="parameters.js"></script>

    <!-- Applying default style here -->
    <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /* set background color to grey during rest */
        .trigger {
            margin: 0%;
            max-width: 100%;
        }

        /*Hide scrollbar while keeping it functional */
        body {
            overflow-y: scroll;
        }

        Body::-webkit-scrollbar {
            display: none
        }
    </style>

</head>

<body>

</body>

<script>
    /* ----------------- Initialize experiment ----------------- */
    var jsPsych = initJsPsych({
        // override_safe_mode: true,
        on_finish: function () {
            if (raw_data == false) {
                jsPsych.data.allData.trials = [clean_data()]
            }
            jsPsych.data.displayData('json')
            jsPsych.data.get().localSave('json', `${jsPsych.data.get().values()[0]["participant_id"]}_RestingStateQuestionnaire.json`);
        }
    });

    /* ----------------- Session Info ----------------- */

    // Participant information
    var participant_info = {
        type: jsPsychSurveyText,
        questions: [
            { prompt: "Enter the participant's ID:", placeholder: "S00", name: "Participant_ID" },
        ],
        data: {
            screen: 'participant_info',
            version: version,
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
        },
        on_finish: function () {
            jsPsych.data.addProperties({ "participant_id": jsPsych.data.get().last().values()[0]["response"]["Participant_ID"] })
        }
    };



    /* ----------------- Preloading ----------------- */
    // Preload audio variables
    var beep = ['utils/beep.mp3'];
    var preload_audio = {
        type: jsPsychPreload,
        auto_preload: true,
        audio: beep
    };


    /* ----------------- Experiment Variables ----------------- */

    // Enter/exit fullscreen mode
    var fullscreen_on = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
    };
    var fullscreen_off = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    };

    // Instructions
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p><b>Instructions</b></p>" +
            // Don't give exact time so that participants don't count
            "<p>A rest period of about 10 minutes is about to start.</p>" +
            "<p>Simply <b>relax</b> and remain seated quietly with your eyes closed. Please try <b>not to fall asleep</b>.</p> " +
            "<p>Once the resting period is over, you will hear a beep. You can then open your eyes and proceed.</p>" +
            "<p>Once you are ready, close your eyes. The rest period will shortly begin.</p>",
        choices: ['Continue'],
    };


    // set trial to trigger onset of resting state trial
    var trigger_marker = {
        type: jsPsychCanvasButtonResponse,
        on_start: function () {
            document.body.style.backgroundColor = '#808080'
            document.body.style.cursor = "none"
        },
        stimulus: function (canvas, color = "black") {
            var ctx = canvas.getContext("2d");
            ctx.beginPath();
            ctx.fillRect(...marker_position);
            //ctx.arc(20, 20, radius, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
        },
        canvas_size: [10000, 10000],
        choices: [],
        trial_duration: 1000,
        css_classes: ['trigger']
    };


    // Create blank grey screen for resting state
    var rest = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p style='font-size:50px;'> +</p>",
        choices: ["s"],
        trial_duration: duration * 60 * 1000,
        css_classes: ['fixation']
    };

    var audio_trigger = {
        type: jsPsychAudioButtonResponse,
        on_start: function () {
            document.body.style.backgroundColor = '#FFFFFF'
            document.body.style.cursor = "auto"
        },
        stimulus: beep,
        prompt: "<p>It's over! Please press continue.</p>",
        choices: ['Continue']
    };

    // Debriefing Questions
    var scale = ['Completely Disagree', 'Completely Agree'];

    var questionnaire = {
        type: jsPsychMultipleSlider,  // this is a custom plugin in utils
        questions: [
            {
                prompt: "<b>I had busy thoughts</b>",
                name: "DoM_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I had rapidly switching thoughts</b>",
                name: "DoM_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I had difficulty holding onto my thoughts</b>",
                name: "DoM_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about others</b>",
                name: "ToM_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about people I like</b>",
                name: "ToM_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I placed myself in other people's shoes</b>",
                name: "ToM_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about my feelings</b>",
                name: "Self_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about my behaviour</b>",
                name: "Self_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about myself</b>",
                name: "Self_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about things I need to do</b>",
                name: "Plan_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about solving problems</b>",
                name: "Plan_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about the future</b>",
                name: "Plan_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I felt sleepy</b>",
                name: "Sleep_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I felt tired</b>",
                name: "Sleep_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I had difficulty staying awake</b>",
                name: "Sleep_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I felt comfortable</b>",
                name: "Comfort_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I felt happy</b>",
                name: "Comfort_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I felt relaxed</b>",
                name: "Comfort_3",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I was conscious of my body</b>",
                name: "SomA_1",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about my heartbeat</b>",
                name: "SomA_2",
                ticks: scale, required: questions_required
            },
            {
                prompt: "<b>I thought about my breathing</b>",
                name: "SomA_3",
                ticks: scale, required: questions_required
            },
            // {
            //     prompt: "<b>I felt ill</b>",
            //     name: "Health_1",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I thought about my health</b>",
            //     name: "Health_2",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I felt pain</b>",
            //     name: "Health_3",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I thought in images</b>",
            //     name: "Visual_1",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I pictured events</b>",
            //     name: "Visual_2",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I pictured places</b>",
            //     name: "Visual_3",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I thought in words</b>",
            //     name: "Verbal_1",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I had silent conversations</b>",
            //     name: "Verbal_2",
            //     ticks: scale, required: questions_required
            // },
            // {
            //     prompt: "<b>I imagined talking to myself</b>",
            //     name: "Verbal_3",
            //     ticks: scale, required: questions_required
            // },
        ],
        randomize_question_order: true,
        preamble: "<p>We are interested in the potential feelings and thoughts you may have experienced during the resting period.</p>" +
            "<p>Please indicate the extent to which you agree with each statement.</p><br /><br/> ",
        require_movement: questions_required,
        slider_width: null,
        data: {
            screen: 'questionnaire',
        }
    };



    /* ----------------- Run the timeline ----------------- */
    jsPsych.run([
        participant_info,
        preload_audio,
        fullscreen_on,
        instructions,
        trigger_marker,
        rest,
        trigger_marker,
        audio_trigger,
        fullscreen_off,
        questionnaire,
        // end_screen,
    ])

    function clean_data() {
        // var dat = jsPsych.data.get().filter({ screen: "participant_info" }).values()[0]
        // var info = {}
        // for (const i of ["date", "time", "version", "rt"]) {
        //     info[i] = dat[i]
        // }
        // info['participant_id'] = dat["response"]["Participant_ID"]

        // dat = jsPsych.data.get().filter({ screen: "questionnaire" }).values()[0]
        // values = JSON.parse(dat["response"])
        // var out = {}
        // for (const [index, element] of Object.entries(values)) {
        //     console.log(index, element);
        //     out[index] = Object.assign({}, { "Answer": element, "Item": index }, info);
        // }
        var info = jsPsych.data.get().filter({ screen: "participant_info" }).values()[0]
        var items = jsPsych.data.get().filter({ screen: "questionnaire" }).values()[0]
        items["response"] = JSON.parse(items["response"])
        items["question_order"] = JSON.parse(items["question_order"])
        var out = Object.assign({}, info, items)
        return out
    }


</script>

</html>