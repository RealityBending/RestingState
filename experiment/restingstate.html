<!-- Load jsPsych-->
<!DOCTYPE html>
<html>

<head>
    <!--create title shown in tab; not the same as header on webpage-->
    <title>RestingState</title>

    <script src="https://unpkg.com/jspsych@7.2.3"></script>

    <!--Load all necessary plugins using cdn hosted library-->
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-button-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
    <script src="utils/multiple-slider.js"></script>

    <!-- Applying default style here -->
    <link href="https://unpkg.com/jspsych@7.2.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /* set background color to grey during rest */
        .rest {
            background-color: #808080;
            color: #808080;
            margin: 0%;
            max-width: 100%;
        }

        /*Hide scrollbar while keeping it functional */
        body {
            overflow-y: scroll;
        }

        Body::-webkit-scrollbar {
            display: none
        }
    </style>

</head>

<body>

</body>

<script>
    /* ----------------- Initialize experiment ----------------- */
    var jsPsych = initJsPsych({
        timeline: timeline,
        experiment_width: 2000,
        on_finish: function () {
            jsPsych.data.get().localSave('csv', `${SubjectID}_restingdata.csv`);
        }
    });

    /* ----------------- Experiment Variables ----------------- */

    // assign random subject id with 10 characters
    var SubjectID = jsPsych.randomization.randomID(10);

    // add the subject id to every trial in the data
    jsPsych.data.addProperties({
        subject: SubjectID
    });

    //  var start_time = jsPsych.getStartTime(); /* get start time of the experiment */

    // var session_info = {
    //   participant_id: subject_id,
    //    time: start_time,
    // };


    // Preload audio variables
    var audio = ['alarm.mp3'];

    var preload_audio = {
        type: jsPsychPreload,
        auto_preload: true,
        audio: audio
    };

    // Enter/exit fullscreen mode
    var fullscreen_on = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
    };
    var fullscreen_off = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    };

    // Participant information
    var participant_info = {
        type: jsPsychSurveyText,
        questions: [
            { prompt: "Please enter the participant's ID:", name: 'Participant', required: true },
        ],
    };

    // Instructions
    var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p><b>INSTRUCTIONS</b></p> " +
            "<p>In this task, you will be required to simply close your eyes and stay still for a certain amount of time (less than 10 minutes) without falling asleep.</p>" +
            "<p> Please try not to think of anything and relax as you are doing so.</p>" +
            "<p>Once you have read and understood the instructions, please close your eyes and wait for the instructor to start the task.</p>" +
            "<p><i>(Press ENTER to continue)</i></p>",
        choices: ["ENTER"],
    };

    //onset of trial
    // var trial = {
    //     type: jsPsychSketchpad,
    //     canvas_shape: 'rectangle',
    //     canvas_width: 30,
    //     canvas_height: 30,
    //     canvas_border_width: 0.1,
    //     choices: "NO_KEYS",
    //     trial_duration: 2000,
    //     show_finished_button: false,
    //     show_undo_button: false,
    //     show_clear_button: false,
    //     show_redo_button: false,
    //     canvas_border_color: '#000000',
    //     background_color: '#000000'
    // };

    // create black rectangle to trigger photosensor
    function trigger(canvas, color) {
        var ctx = canvas.getContext("2d");
        ctx.beginPath();
        ctx.fillRect(1205, 5, 40, 40);
        //ctx.arc(20, 20, radius, 0, 2 * Math.PI);
        ctx.fillStyle = color;
        ctx.fill();
    }
    // set trial to trigger onset of resting state trial
    var trigger_sensor = {
        type: jsPsychCanvasButtonResponse,
        stimulus: function (c) {
            trigger(c, 'black');
        },
        canvas_size: [2000, 2000],
        choices: [],
        stimulus_duration: 500,
        trial_duration: 500
    };

    // create blank grey screen for resting state
    var rest = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>.</p>",
        choices: "NO_KEYS",
        trial_duration: 6000,  // set trial duration to 8 minutes (480000) once finalized
        css_classes: ['rest']
    };

    var audio_trigger = {
        type: jsPsychAudioButtonResponse,
        stimulus: 'alarm.mp3',
        prompt: '<p> </p><p>You can open your eyes and continue with the rest of the task.</p)',
        choices: ['Continue']
    };

    // Debriefing Questions - NYC-Q
    // var scale = ["<p>1</p><p>Not at All</p>", "2", "3", "4", "5", "6", "7", "8", "<p>9</p><p>Very Much</p>"];

    var scale = ['Not at All', 'Very Much']

    var NYCQ = {
        type: jsPsychMultipleSlider,  // this is a custom plugin in utils
        questions: [
            { prompt: "I thought about things I am currently worried about", ticks: scale, required: true },
            { prompt: "I thought about people I have just recently met", ticks: scale, required: true },
            { prompt: "I thought of people I have known for a long time (friends)", ticks: scale, required: true },
            { prompt: "I thought about members of my family", ticks: scale, required: true },
            { prompt: "I thought about an event that took place earlier today", ticks: scale, required: true },
            { prompt: "I thought about an interaction I may possibly have in the future", ticks: scale, required: true },
            { prompt: "I thought about an interaction with somebody that took place in the past", ticks: scale, required: true },
            { prompt: "I thought about something that happened at a place very close to me", ticks: scale, required: true },
            { prompt: "I thought about something that made me feel guilty", ticks: scale, required: true },
            { prompt: "I thought about an event that may take place later today", ticks: scale, required: true },
            { prompt: "I thought about something that happened in the recent past (last couple of days but not today)", ticks: scale, required: true },
            { prompt: "I thought about something that happened a long time ago in the past", ticks: scale, required: true },
            { prompt: "I thought about something that made me angry", ticks: scale, required: true },
            { prompt: "I thought about something that made me happy", ticks: scale, required: true },
            { prompt: "I thought about something that made me cheerful", ticks: scale, required: true },
            { prompt: "I thought about something that made me calm", ticks: scale, required: true },
            { prompt: "I thought about something that made me sad", ticks: scale, required: true },
            { prompt: "I thought about something that is important to me", ticks: scale, required: true },
            { prompt: "I thought about something that could still happen today", ticks: scale, required: true },
            { prompt: "I thought about something that may take place in the distant future", ticks: scale, required: true },
            { prompt: "I thought about something that could take place in the near future (days or weeks but not today)", ticks: scale, required: true },
            { prompt: "I thought about personal worries", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were in the form of images", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were in the form of words", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were like an inner monologue or audiobook", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were like a television program or film", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts had a strong and consistent personal narrative", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts had a clear sense of purpose", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were vague and non-specific", ticks: scale, required: true },
            { prompt: "During the EEG my thoughts were fragmented and disjointed", ticks: scale, required: true },
        ],
        randomize_question_order: false,
        preamble: "We are interested in the thoughts you had during the EEG. Please indicate the extent to which each of these statements correctly characterizes your thinking. Please indicate, using the scale provided, how much the statement characterizes your thoughts during the EEG. <br /><br/> ",
        randomize_question_order: false,
        require_movement: true,
        slider_width: 1150,
    };

    // end block
    var end_screen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>You have come to the end of the first phase of this experiment.</p><p>Please let the experimenter know.</p>",
        choices: "NO_KEYS",
        trial_duration: 5000,
        data: { type: 'final_data' },
        // on_finish: function () {
        //     jsPsych.endExperiment();
        //     var data_saved = jsPsych.data.get().json(true), ".data/";
        //     commitToRepo(jsPsych.data.get().json(true), ".data/" + ParticipantID + ".json")  // Send data to Netlify function
        // },
    };

    // // Utility Functions
    // /* SAVING DATA FUNCTION ================== */

    // function commitToRepo(jsonData, path) {
    //     const url = ".netlify/functions/api"

    //     // Example:
    //     const response = fetch(url, {
    //         method: 'POST', // *GET, POST, PUT, DELETE, etc.
    //         mode: 'no-cors', // no-cors, *cors, same-origin
    //         cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
    //         credentials: 'same-origin', // include, *same-origin, omit
    //         headers: {
    //             'Content-Type': 'application/json'
    //         },
    //         redirect: 'follow', // manual, *follow, error
    //         referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
    //         body: JSON.stringify({
    //             path: path,
    //             data: JSON.stringify(jsonData)
    //         }) // body data type must match "Content-Type" header
    //     }).then((response) => {
    //         console.log(response)
    //     })
    //  }

    // var NYCQ = {
    //     type: jsPsychSurveyLikert,
    //     questions: [
    //         {prompt: "I thought about things I am currently worried about", labels: scale, required: true},
    //         {prompt: "I thought about people I have just recently met", labels: scale, required: true},
    //         {prompt: "I thought of people I have known for a long time (friends)", labels: scale, required: true},
    //         {prompt: "I thought about members of my family", labels: scale, required: true},
    //         {prompt: "I thought about an event that took place earlier today", labels: scale, required: true},
    //         {prompt: "I thought about an interaction I may possibly have in the future", labels: scale, required: true},
    //         {prompt: "I thought about an interaction with somebody that took place in the past", labels: scale, required: true},
    //         {prompt: "I thought about something that happened at a place very close to me", labels: scale, required: true},
    //         {prompt: "I thought about something that made me feel guilty", labels: scale, required: true},
    //         {prompt: "I thought about an event that may take place later today", labels: scale, required: true},
    //         {prompt: "I thought about something that happened in the recent past (last couple of days but not today)", labels: scale, required: true},
    //         {prompt: "I thought about something that happened a long time ago in the past", labels: scale, required: true},
    //         {prompt: "I thought about something that made me angry", labels: scale, required: true},
    //         {prompt: "I thought about something that made me happy", labels: scale, required: true},
    //         {prompt: "I thought about something that made me cheerful", labels: scale, required: true},
    //         {prompt: "I thought about something that made me calm", labels: scale, required: true},
    //         {prompt: "I thought about something that made me sad", labels: scale, required: true},
    //         {prompt: "I thought about something that is important to me", labels: scale, required: true},
    //         {prompt: "I thought about something that could still happen today", labels: scale, required: true},
    //         {prompt: "I thought about something that may take place in the distant future", labels: scale, required: true},
    //         {prompt: "I thought about something that could take place in the near future (days or weeks but not today)", labels: scale, required: true},
    //         {prompt: "I thought about personal worries", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were in the form of images", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were in the form of words", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were like an inner monologue or audiobook", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were like a television program or film", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts had a strong and consistent personal narrative", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts had a clear sense of purpose", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were vague and non-specific", labels: scale, required: true},
    //         {prompt: "During the EEG my thoughts were fragmented and disjointed", labels: scale, required: true},
    //     ],
    //     randomize_question_order: false,
    //     preamble: "<p>We are interested in the thoughts you had during the EEG.</p><p>Please indicate the extent to which each of these statements correctly characterizes your thinking.</p><p>Please indicate, using the scale provided, how much the statement characterizes your thoughts during the EEG.</p>",
    //     scale_width: 1200,
    //     data: {type: 'NYCQ_responses'},
    // };

    /* ----------------- Set the timeline ----------------- */
    var timeline = [preload_audio, participant_info, fullscreen_on, instructions, trigger_sensor, rest, trigger_sensor, audio_trigger, fullscreen_off, NYCQ, end_screen];

    jsPsych.run(timeline);

</script>

</html>